<html>

<head>
    <script src="https://js.leapmotion.com/leap-0.6.4.min.js"></script>
</head>

<body>

    <div id="pointDiv">
        <h1>사다리타기</h1>
        <div id="pointSpan">
            <span><img src="img/empty.png" id="point1"></span>
            <span><img src="img/empty.png" id="point2"></span>
            <span><img src="img/empty.png" id="point3"></span>
            <span><img src="img/empty.png" id="point4"></span>
            <span><img src="img/empty.png" id="point5"></span>
        </div>
    </div>

    <div id="container">
        <span id="destination"></span>
        <span id="question">을(를) 찾아가세요.</span>
    </div>

    <!-- 이미지를 담을 테이블 생성 -->
    <table id="ladderTb">
        <tr>
            <td style="width: 200px; height:215px;">
                <div class="back"><img src="" id="destination0"></div>
                <div class="front"><img src="" id="answer0"></div>
            </td>
            <td style="width: 200px; height:200px;">
                <div class="back"><img src="" id="destination1"></div>
                <div class="front"><img src="" id="answer1"></div>
            </td>
            <td style="width: 200px; height:200px;">
                <div class="back"><img src="" id="destination2"></div>
                <div class="front"><img src="" id="answer2"></div>
            </td>
            <td style="width: 200px; height:200px;">
                <div class="back"><img src="" id="destination3"></div>
                <div class="front"><img src="" id="answer3"></div>
            </td>
            <td style="width: 200px; height:200px;">
                <div class="back"><img src="" id="destination4"></div>
                <div class="front"><img src="" id="answer4"></div>
            </td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td><img src="" id="btn1"></td>
            <td><img src="" id="btn2"></td>
            <td><img src="" id="btn3"></td>
            <td><img src="" id="btn4"></td>
            <td><img src="" id="btn5"></td>
        </tr>
    </table>
</body>
<style>
    body {
        position: relative;
    }

    #container {
        position: absolute;
        top: 30%;
        left: 50%;
        margin-left: -50%;
        width: 100%;
        text-align: center;
    }

    .front,
    .back {
        width: 200px;
        height: 215px;
        position: absolute;
        top: 0;
    }

    #question {
        font-size: 30px;
    }

    #pointDiv {
        position: fixed;
        top: 0;
        width: 100%;
    }

    #ladderTb {
        visibility: hidden;
        border-collapse: collapse;
        margin: 5% auto;
        text-align: center;
    }

    #pointSpan {
        position: absolute;
        top: 10%;
        right: 5%;
    }

    #pointSpan img {
        max-width: 100px;
        max-height: 100px;
        width: auto;
        height: auto;
    }

    td,
    tr {
        padding: 0;
    }

    td {
        width: 200px;
    }
</style>
<script>
    // 시작
    start();

    var isPause = false;
    var connSet = null;
    var ladderTb = document.getElementById('ladderTb');
    var temp = Array(Array(), Array(), Array(), Array(), Array());
    var gameCnt = 5;
    var green = 0;  // 정답
    var red = 0;    // 오답

    // 문제 출력
    function start() {
        var imgStr = ["은행", "소방서", "병원", "도서관", "박물관", "경찰서", "우체국", "학교"];

        var destination = document.getElementById('destination');
        destination.style.fontSize = "50px";
        destination.style.fontWeight = "bold";
        document.getElementById('container').style.visibility = "visible";
        document.getElementById('ladderTb').style.visibility = "hidden";

        var ran = Math.floor(Math.random() * imgStr.length);

        switch (ran) {
            case 0:
                destination.style.color = "#DAA520";
                break;
            case 1:
                destination.style.color = "#B22222";
                break;
            case 2:
                destination.style.color = "#006400";
                break;
            case 3:
                destination.style.color = "#8B4513";
                break;
            case 4:
                destination.style.color = "#191970";
                break;
            case 5:
                destination.style.color = "#4682B4";
                break;
            case 6:
                destination.style.color = "#FF0000";
                break;
            case 7:
                destination.style.color = "#483D8B";
                break;
        }

        destination.innerHTML = imgStr[ran];

        // 번호 버튼/정답표시 이미지 초기화
        for (var i = 1; i < 6; i++) {
            document.getElementById("btn" + i + "").src = "img/" + i + ".png";
            document.getElementById("answer"+(i-1)+"").src = "";
        }

        setTimeout(() => {
            document.getElementById('container').style.visibility = "hidden";
        }, 2000);

        setTimeout(() => {
            ladderGame(ran, imgStr, imgStr[ran]);
            document.getElementById('ladderTb').style.visibility = "visible";
        }, 4000);
    }

    // 사다리 Game img 생성
    function ladderGame(ran, imgStr, answer) {
        var building = ["img/bank.png", "img/fireStation.png", "img/hospital.png", "img/library.png", "img/museum.png", "img/police.png", "img/postOffice.png", "img/school.png"];

        //console.log("ladderGame : ", answer);
        // 0~6까지 중복되지 않는 랜덤 숫자 4개 생성
        var array = [];
        var num = 0;
        array.push(ran);

        while (num < 4) {
            var r = Math.floor(Math.random() * building.length);
            if (!sameNum(r)) {
                array.push(r);
                num++;
            }
        }

        // 중복검사
        function sameNum(r) {
            for (var i = 0; i < array.length; i++) {
                if (r == array[i]) {
                    return true;
                }
            }
            return false;
        }
        //console.log("array : ", array);
        shuffle(array);

        // 이미지 순서 섞기
        function shuffle(a) {
            var i, j, k;

            for (i = a.length; i; i--) {
                j = Math.floor(Math.random() * i);
                k = a[i - 1];
                a[i - 1] = a[j];
                a[j] = k;
            }
        }

        // 이미지 랜덤 생성
        for (var i = 0; i < array.length; i++) {
            document.getElementById("destination" + i + "").src = building[array[i]];
            temp[i][0] = imgStr[array[i]];
        }

        // 사다리 생성
        var lineImg = ['a.png', 'straight.png', 'eo.png'];

        for (var j = 0; j < 5; j++) {
            for (var i = 1; i < 9; i++) {
                if (j == 0) {
                    var ran = Math.floor(Math.random() * (lineImg.length - 1));
                    ladderTb.rows[i].cells[j].innerHTML = "<img src= 'img/" + lineImg[ran] + "'>";
                    temp[j][i] = ran;
                } else if (temp[j - 1][i] == 0) {
                    ladderTb.rows[i].cells[j].innerHTML = "<img src= 'img/" + lineImg[2] + "'>";
                    temp[j][i] = 2;
                } else {
                    var ran = Math.floor(Math.random() * (lineImg.length - 1));
                    ladderTb.rows[i].cells[j].innerHTML = "<img src= 'img/" + lineImg[ran] + "'>";
                    temp[j][i] = ran;
                }

                if (j == 4 && temp[j][i] == 0) {
                    ladderTb.rows[i].cells[j].innerHTML = "<img src= 'img/" + lineImg[1] + "'>";
                    temp[j][i] = 1;
                }
            }
        }
        //console.log(temp);
        connLeap(ran, answer);
    }

    // leapmotion
    function connLeap(ran, answer) {
        //console.log("leap : ", answer);
        isPause = false;
        connSet = null;

        if (!isPause) {
            var controller = new Leap.Controller();
            controller.connect();

            controller.on('connect', function () {
                var count = [0, 0, 0, 0, 0];

                if (connSet == null) {
                    connSet = setInterval(function () {
                        var frame = controller.frame();
                        if (frame.hands.length > 0) {
                            var hand = frame.hands[0];
                            var fingers = hand.fingers[0];
                            var extendedFingers = 0;

                            for (var f = 0; f < hand.fingers.length; f++) {
                                var finger = hand.fingers[f];
                                if (finger.extended) extendedFingers++;
                            }

                            count[extendedFingers - 1]++;
                            //console.log("extendedFingers : ", extendedFingers);
                            //console.log("count : " , count);

                            for (var i = 0; i < count.length; i++) {
                                if (count[i] > 200) {
                                    count = [0, 0, 0, 0, 0];
                                    controller.disconnect();
                                    selectBtn(i + 1, answer);
                                }
                            }
                        }
                    }, 10);
                }
            });
        }
    }

    // 번호 선택
    function selectBtn(i, answer) {
        //console.log("selectBtn : ", answer);
        clearInterval(connSet);
        isPause = true;
        //console.log("selectBtn i : ", i);
        document.getElementById("btn" + i + "").src = "img/" + i + "_green.png";

        setTimeout(play, 1500, i - 1, answer);
    }

    // 사다리타고 올라가기
    function play(i, answer) {
        //console.log("play i : ", i);
        var j = 8;

        while (j > 0) {
            if (temp[i][j] == 0) {  //ㅏ 일 때,
                ladderTb.rows[j].cells[i].innerHTML = "<img src= 'img/a_red_d.png'>";
                ladderTb.rows[j].cells[i + 1].innerHTML = "<img src= 'img/eo_red_u.png'>";
                i++;
            }
            else if (temp[i][j] == 1) {  // ㅣ 일 때,
                ladderTb.rows[j].cells[i].innerHTML = "<img src= 'img/straight_red.png'>";
            }
            else if (temp[i][j] == 2) { //ㅓ 일 때
                ladderTb.rows[j].cells[i].innerHTML = "<img src= 'img/eo_red_d.png'>";
                ladderTb.rows[j].cells[i - 1].innerHTML = "<img src= 'img/a_red_u.png'>";
                i--;
            }
            j--;
            // console.log("temp i : ", i, "temp j : ", j);
            // console.log("play temp : ", temp[i][j]);
        }

        // console.log(temp[i][j]);
        // console.log(answer);
        if (temp[i][j] == answer) {
            //console.log("정답입니다");
            green++;
            var p = 6-gameCnt;
            document.getElementById('answer'+i+'').src = "img/answer.png";
            document.getElementById('point'+p+'').src = "img/green.png";
            restart();
        } else {
            //console.log("틀렸습니다");
            red++;
            var p = 6-gameCnt;
            document.getElementById('point'+p+'').src = "img/red.png";
            restart();
        }
    }

    // 게임횟수 검사
    function restart() {
        gameCnt--;
        if (gameCnt > 0) {
            setTimeout(start, 2000);
        } else {
            console.log("끝");
        }
    }

</script>

</html>